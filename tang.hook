#! /bin/bash

set -e

echo "# tang.hook invoked at ${TANG_REF}"

if ! go test -v;
then
	echo "Tests failed"
	exit 1
fi

mkdir -p gopath/src
ln -s $PWD gopath/src/tang

echo "Installing..."
GOPATH=$PWD/gopath go install tang

# Must delete old binary before replacing it
ORIGBIN=${GOPATH-~/.local}/bin/tang
mv $ORIGBIN $ORIGBIN.old
cp $PWD/gopath/bin/tang $ORIGBIN

pkill -HUP tang
